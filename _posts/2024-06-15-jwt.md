---
title: "[Spring_Security] í† í° ê¸°ë°˜ ì¸ì¦ ë°©ì‹ì˜ JWT ì¸ì¦ ë° ì¸ê°€ ê³¼ì • êµ¬í˜„ê³¼ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ Filter Chain"
date: 2024-06-15 18:28 +0900
lastmod: 2024-06-15 18:28 +0900
categories: Spring_Security
tags:
  [
    OncePerRequestFilter,
    AbstractAuthenticationProcessingFilter,
    Jwt Token,
    AbstractAuthenticationToken,
    BasicAuthenticationFilter,
    FilterChain,
    AuthenticationException
  ]
---

## ì¸ì¦ ìš”ì²­ ê°€ë¡œì±„ê¸°, OncePerRequestFilter

<div style="margin-bottom: 15px;font-size:20px;background-color:#FFD24D;color:black;font-weight:normal;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    ğŸ€ OncePerRequestFilterëŠ” ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì—ì„œ ì œê³µí•˜ëŠ” ì¶”ìƒí´ë˜ìŠ¤ì´ë‹¤
</div>

`ğŸŒ±OncePerRequestFilter`ëŠ” <span style='color:rgb(196,58,26);'>íŠ¹ì • í•„í„°ê°€ ê° ìš”ì²­ë‹¹ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥</span>í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgba(0,0,0,0.03);">ì´ëŠ” ì¤‘ë³µì‹¤í–‰ì„ ë°©ì§€í•œë‹¤.</span>

`ğŸŒ±OncePerRequestFilter`ëŠ” ì¶”ìƒí´ë˜ìŠ¤ì´ë¯€ë¡œ, ì´ë¥¼ ìƒì†ë°›ì€  
`ğŸ¦©InitialAuthenticationFilter`ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ë¥¼ ì‚¬ìš©í•˜ì—¬ <span style='color:rgb(196,58,26);'>ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•  ë•Œ ì‚¬ìš©ë˜ëŠ” í•„í„°</span>ë¡œ ì»¤ìŠ¤í…€ í•  ìˆ˜ ìˆë‹¤.

`ğŸ¦©InitialAuthenticationFilter`ëŠ” **ì´ˆê¸° ì¸ì¦ ìš”ì²­ì„ ê°€ë¡œì±„ê³  ì²˜ë¦¬**í•˜ëŠ” ì—­í• ì„ í•œë‹¤.  
ì¸ì¦ ì²˜ë¦¬ í›„, ì„±ê³µí•˜ë©´ <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#BCD4E6;">ì‚¬ìš©ì ì •ë³´ë¥¼ ë³´ì•ˆì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•œë‹¤.</span>

`â˜• InitialAuthenticationFilter.java`

```java
public class InitialAuthenticationFilter extends OncePerRequestFilter {
    private final AuthenticationManager authenticationManager;

    public IntialAuthenticationFilter(AuthenticationManager authenticationManager) {
        this.authenticationManager = authenticationManager;
    }

    @Override // ì›í•˜ëŠ” í•„í„°ë§ ë¡œì§ ì •ì˜
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        filterChain.doFilter(request, response);
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        return !request.getServletPath().equals("/api/sign-in");
    }

    @Override
    protected String getAlreadyFilteredAttributeName() {
        return getClass().getName() + ".FILTERED";
    }
}
```

`ğŸŒ±OncePerRequestFilter`ë¥¼ í™•ì¥í•œ `ğŸ¦©InitialAuthenticationFilter`ëŠ” <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#BCD4E6;">ê° ìš”ì²­ë‹¹ í•œë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥</span>í•  ê²ƒì´ê³ ,  
ê·¸ë ‡ê¸°ì— (ì¸ì¦ì´ í•„ìš”í•œ) ìš”ì²­ë‹¹ í•œ ë²ˆë§Œ ì“°ì´ëŠ” <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#BCD4E6;">ì‚¬ìš©ì ì¸ì¦ì„ ì²˜ë¦¬í•˜ê¸° ì¢‹ì€ í•„í„°ê°€ ëœë‹¤.</span>

`shouldNotFilter` ë©”ì„œë“œëŠ” <span style='color:rgb(196,58,26);'>íŠ¹ì • ìš”ì²­ì— ëŒ€í•´ì„œë§Œ í•„í„°ë¥¼ íƒ€ê²Œí•˜ê±°ë‚˜ ê±´ë„ˆë›°ê³ ì í•  ë•Œ</span> ì˜¤ë²„ë¼ì´ë“œ í•  ìˆ˜ ìˆë‹¤.

`getAlreadyFilteredAttributeName` ë©”ì„œë“œëŠ” ìš”ì²­ë‹¹ í•„í„°ë§ì´ ì´ë¯¸ ìˆ˜í–‰ë˜ì—ˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì†ì„± ì´ë¦„ì„ ë°˜í™˜í•œë‹¤.

## íŠ¹ì • URL íŒ¨í„´ ë§¤ì¹­ ì¸ì¦ í•„í„°, AbstractAuthenticationProcessingFilter

<div style="margin-bottom:15px;font-size:20px;background-color:rgb(35,43,47);color:white;font-weight:normal;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    ğŸ AbstractAuthenticationProcessingFilterëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì œê³µí•˜ëŠ” ì¶”ìƒí´ë˜ìŠ¤ì´ë‹¤
</div>

`ğŸ›¡ï¸AbstractAuthenticationProcessingFilter`ëŠ” <span style='color:rgb(196,58,26);'>ì¸ì¦ ìš”ì²­ì„ ì²˜ë¦¬</span>í•˜ê³ , ì„±ê³µ í˜¹ì€ ì‹¤íŒ¨ ì‹œ ê°ê¸° ë‹¤ë¥¸ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.

- attemptAuthentication  
  : í•´ë‹¹ ë©”ì„œë“œë¥¼ êµ¬í˜„í•˜ì—¬ ì‚¬ìš©ì ì¸ì¦ ë¡œì§ì„ ì •ì˜í•œë‹¤.

  ```java
  @Override
  public abstract Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)
    throws AuthenticationException, IOException, ServletException;
  ```

- successfulAuthentication
  : ì¸ì¦ì´ ì„±ê³µí–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œì´ë‹¤.  
  : ë³´ì•ˆì»¨í…ìŠ¤íŠ¸ì— ì¸ì¦ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ë‹¤ìŒ í•„í„°ë¡œ ìš”ì²­ì„ ì „ë‹¬í•œë‹¤.

  ```java
  protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult)
   throws IOException, ServletException {
    SecurityContextHolder.getContext().setAuthentication(authResult);
    chain.doFilter(request, response);
   }
  ```

- unsuccessfulAuthentication  
  : ì¸ì¦ì´ ì‹¤íŒ¨í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œì´ë‹¤.  
  : ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤íŒ¨ ì´ìœ ë¥¼ ë¡œê¹…í•˜ê³ , ì ì ˆí•œ HTTP ì‘ë‹µì„ ë°˜í™˜í•œë‹¤.

  ```java
  protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed)
   throws IOException, ServletException {
    SecurityContextHolder.clearContext();

    response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Authentication Failed");
   }
  ```

- requiresAuthentication  
   : íŠ¹ì • ìš”ì²­ì´ ì¸ì¦ì„ í•„ìš”ë¡œ í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ë©”ì„œë“œì´ë‹¤.  
   : ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì •ëœ url íŒ¨í„´ê³¼ ìš”ì²­ urlì„ ë¹„êµí•˜ì—¬ ì¸ì¦ í•„ìš” ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.

  ```java
  protected boolean requiresAuthentication(HttpServletRequest request, HttpServletResponse response) {
   return requiresAuthenticationRequestMatcher.matches(request);
  }
  ```

`â˜• JwtAuthenticationFilter.java`

```java
public class JwtAuthenticationFilter extends AbstractAuthenticationProcessingFilter {
  private static final AntPathRequestMatcher DEFAULT_FILTER_PROCCESSING_URL = new AntPathRequestMatcher("/api/sign-in", HttpMethod.POST.name());

  private final JwtTokenProvider jwtTokenProvider;

  public JwtAuthenticationFilter(AuthenticationManager authenticationManager, JwtTokenProvider jwtTokenProvider) {
    super(DEFAULT_FILTER_PROCESSING_URL, authenticationManager);
    this.jwtTokenProvider = jwtTokenProvider;
  }

  @Override
  public Authentication attemptAuthentication(
      HttpServletRequest request,
      HttpServletResponse response) throws AuthenticationException {

    // ...(jwt í† í°ì„ ì´ìš©í•œ ì‚¬ìš©ì ì¸ì¦ ë¡œì§ ìƒëµ)

    UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);
    return this.getAuthenticationManager().authenticate(authRequest);
  }

  @Override
  protected void successfulAuthentication(
      HttpServletRequest request,
      HttpServletResponse response,
      FilterChain chain,
      Authentication authResult) throws IOException {

    // ... (ë³´ì•ˆì»¨í…ìŠ¤íŠ¸ì— ì¸ì¦ì •ë³´ ì €ì¥ ë¡œì§ ìƒëµ)
  }

  @Override
  protected void unsuccessfulAuthentication(
      HttpServletRequest request,
      HttpServletResponse response,
      AuthenticationException failed) throws IOException {

    response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Authentication Failed");
  }
}
```

ìƒì„±ìë¥¼ í˜¸ì¶œí•  ë•Œ ì“°ì´ëŠ”`ğŸ›¡ï¸AntPathRequestMatcher`ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ <span style='color:rgb(196,58,26);'>url íŒ¨í„´ì„ ë§¤ì¹­í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” í´ë˜ìŠ¤</span>ë‹¤.  
Springì˜ `Ant Style Path Pattern`ì„ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ urlì´ íŠ¹ì • íŒ¨í„´ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë° ì‚¬ìš©ëœë‹¤.

> ğŸ Ant ìŠ¤íƒ€ì¼ ê²½ë¡œ íŒ¨í„´  
> íŒŒì¼ ì‹œìŠ¤í…œ ê²½ë¡œì™€ ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ url íŒ¨í„´ì„ ì •ì˜í•  ìˆ˜ ìˆê²Œ í•œë‹¤.  
> ë˜í•œ, íŠ¹ì • HTTP ë©”ì„œë“œë¥¼ ì§€ì •í•˜ì—¬ ë§¤ì¹­í•  ìˆ˜ ìˆë‹¤.  
> ê¸°ë³¸ì ìœ¼ë¡œ ëŒ€ì†Œë¬¸ìë¥¼ êµ¬ë¶„í•˜ì§€ë§Œ, êµ¬ë¶„í•˜ì§€ ì•Šë„ë¡ ì„¤ì •í•  ìˆ˜ë„ ìˆë‹¤.

í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ í†µí•´ `/api/sign-in`ì„ ì œì™¸í•œ ëª¨ë“  ìš”ì²­ì€ ê±´ë„ˆë›°ê³ , <span style='color:#9E0ADD;'>ë§¤ì¹­ëœ urlë§Œì´ ë‹¤ìŒ FilterChainì„ íƒ€ê²Œ ëœë‹¤.</span>

`ğŸ›¡ï¸AbstractAuthenticationProcessingFilter`ë¥¼ í™•ì¥í•œ `ğŸ¦©JwtAuthenticationFilter`ëŠ” ì •ì˜í•œ ì¸ì¦ë¡œì§ì„ ì‹œë„í•´ë³´ê³   
ì¸ì¦ì´ ì„±ê³µí•  ì‹œ, ì¸ì¦ ì„±ê³µ ì²˜ë¦¬ ë¡œì§ì„ ì²˜ë¦¬í•œ ë’¤, ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ì— ì¸ì¦ ì •ë³´ë¥¼ ë‹´ì„ ìˆ˜ ìˆë‹¤.

`ğŸ« SecurityConfig.java`

```java
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

  private final CorsFilter corsFilter;
  private final JwtAuthenticationProvider jwtAuthenticationProvider;
  private final JwtTokenProvider jwtTokenProvider;

  @Bean
  public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

    // ...(ìƒëµ)
    http.addFilter(corsFilter).apply(new MyCustomDsl());
    // ...(ìƒëµ)

    return http.build();
  }

  public class MyCustomDsl extends AbstractHttpConfigurer<MyCustomDsl, HttpSecurity> {

    @Override
    public void configure(HttpSecurity http) {

      AuthenticationManager authenticationManager =
        http.getSharedObject(AuthenticationManager.class);

      InitialAuthenticationFilter initialAuthenticationFilter = new InitialAuthenticationFilter();

      JwtAuthenticationFilter jwtAuthenticationFilter =
        new JwtAuthenticationFilter(authenticationManager, jwtTokenProvider);

      http.addFilterBefore(initialAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)
        .addFilterAfter(jwtAuthenticationFilter, InitialAuthenticationFilter.class)
        .authenticationProvider(jwtAuthenticationProvider);

      http.addFilter(new JwtAuthorizationFilter(authenticationManager));
    }
  }
}
```

í•œí¸ `ğŸ«SecurityConfig` ì„¤ì •íŒŒì¼ì—ì„œ, `ğŸ¦©InitialAuthenticationFilter`ì˜ ë‹¤ìŒ í•„í„°ëŠ” `ğŸ¦©JwtAuthenticationFilter`ë¡œ ì§€ì •í•˜ì—¬ `ğŸ¦©InitialAuthenticationFilter`ë¥¼ í†µê³¼í•œ url ìš”ì²­ë§Œì´ `ğŸ¦©JwtAuthenticationFilter`ë¥¼ íƒ€ë„ë¡ êµ¬í˜„í–ˆë‹¤.

ì´ì²˜ëŸ¼, ê¸°ì¡´ì— ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì— ì •ì˜ëœ  
<span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#E1FEE5;">ì¶”ìƒí´ë˜ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒí™©ì— ì•Œë§ì€ ì‚¬ìš©ì ì¸ì¦ ê¸°ëŠ¥ì„ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.</span>

## ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ ë°©ì‹ê³¼ í† í° ê¸°ë°˜ ì¸ì¦ ë°©ì‹

<div style="margin-bottom: 15px;font-size:20px;background-color:#FFD24D;color:black;font-weight:normal;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    ğŸ€ ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ê°ì²´ì— ì €ì¥í•˜ê³ , í† í° ê¸°ë°˜ ì¸ì¦ì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í† í°ì„ ìƒì„±í•œë‹¤
</div>

<div style="margin-bottom:15px;font-size:15px;background-color:rgba(0,0,0,0.03);border-radius:5px;padding:7px;"><span style="font-weight:bold;">ğŸ“˜ ì„¸ì…˜ê³¼ ì¿ í‚¤ë€</span><br>
ìš°ì„  <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#dee2e6;">ì„¸ì…˜</span>ì´ë€ <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#ffff9e;color:#624a3d;">ì„œë²„ì— í´ë¼ì´ì–¸íŠ¸ ë³„ë¡œ ì •ë³´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆëŠ” ì €ì¥ì†Œ</span>ì´ë‹¤.<br>
ê° ì €ì¥ê³µê°„ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” <span style='color:rgb(196,58,26);'>ì„¸ì…˜ID</span>ë¼ëŠ” ê²ƒì´ ì¡´ì¬í•˜ëŠ”ë°,<br>
ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ìµœì´ˆ ì ‘ì† ì‹œ, <span style='color:rgb(196,58,26);'>í•´ë‹¹ ì‚¬ìš©ìë¥¼ ì•ìœ¼ë¡œë„ êµ¬ë³„</span>í•˜ê¸° ìœ„í•´<br>
<span style='color:rgb(196,58,26);'>ì´ ì‚¬ìš©ìë§Œì˜ ì €ì¥ì†Œì— ëŒ€í•œ ì‹ë³„ì</span>, ì„¸ì…˜IDë¥¼ <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#dee2e6;">ì¿ í‚¤</span>ë¼ëŠ” <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#ffff9e;color:#624a3d;">ì‘ì€ ë°ì´í„° íŒŒì¼</span>ì— ë„£ì–´, ì›¹ë¸Œë¼ìš°ì €ë¡œ ë³´ë‚¸ë‹¤.<br><br>
ë”°ë¼ì„œ, ì¿ í‚¤ë¥¼ ì“°ì§€ ì•Šìœ¼ë©´, ì„¸ì…˜ ì €ì¥ì†Œë¥¼ ì‹ë³„í•  IDê°’ë„ ì—†ê¸° ë•Œë¬¸ì— ì„¸ì…˜ë„ ì“°ì§€ ëª»í•œë‹¤.
</div>

**ğŸ¦ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦**  
ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ë©´ ì„œë²„ëŠ” <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ê°ì²´ì— ì €ì¥</span>í•˜ê³ , <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">ì„¸ì…˜IDë¥¼ ìƒì„±</span>í•´  
ë¸Œë¼ìš°ì €ì— <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">ì¿ í‚¤ë¡œ ì „ë‹¬</span>í•œë‹¤.  
ì´ ì´í›„ë¶€í„° ì‚¬ìš©ì ìš”ì²­ì‹œë§ˆë‹¤ <span style='color:rgb(196,58,26);'>ì¿ í‚¤ì— í¬í•¨ëœ ì„¸ì…˜ID</span>ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ê³ ,  
ì„œë²„ëŠ” í•´ë‹¹ ì„¸ì…˜(ì €ì¥ì†Œ)ë¥¼ ì¡°íšŒí•˜ì—¬ ì‚¬ìš©ìë¥¼ ì¸ì¦í•œë‹¤.

ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ì€ <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#E1FEE5;">ë³´ì•ˆ ì¸¡ë©´ì—ì„œ ìš°ìˆ˜í•˜ë‹¤.</span>  
 ì¦‰, í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì •ë³´(ì„¸ì…˜)ê°€ íƒˆì·¨ë˜ë”ë¼ë„ ì–´ì°¨í”¼ ì‚¬ìš©ì ì •ë³´ëŠ” ì„œë²„ì— ìˆê¸° ë•Œë¬¸ì—  
 íƒˆì·¨ëœ ì„œë²„ì˜ ì„¸ì…˜IDë§Œ ë³€ê²½í•˜ë©´ ëœë‹¤.

ğŸ í•˜ì§€ë§Œ ì¼ë°˜ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ê°€ ì›¹ ë¸Œë¼ìš°ì €ê°€ ì•„ë‹Œ ê²½ìš°, ì¿ í‚¤ë¥¼ ì˜ ì“°ì§€ ì•ŠëŠ”ë‹¤.  
 ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ì€ ì¿ í‚¤ì— ì˜ì¡´ì ì´ë¯€ë¡œ, ì¿ í‚¤ ì‚¬ìš©ì„ ë§‰ëŠ” í™˜ê²½ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ë˜í•œ ê²°êµ­, ì„¸ì…˜ì´ë€ê±´ ì„œë²„ì•ˆì˜ ì €ì¥ì†Œì´ê¸° ë•Œë¬¸ì— <span style="margin-bottom:16px;font-size:18px;background-color:#ffdce0;color:rgb(196,58,26);border-radius:5px;padding:2px 3px;">ì„œë²„ê°€ ìƒíƒœë¥¼ ìœ ì§€</span>í•´ì•¼ í•œë‹¤.  
 ğŸ ì´ëŠ” ë¬´ìƒíƒœì„±(stateless)ë¥¼ ì§€í–¥í•˜ëŠ” Restful ì•„í‚¤í…ì²˜ì™€ ë§ì§€ ì•ŠëŠ”ë‹¤.

ğŸ ë”ë¶ˆì–´, ì„œë²„ê°€ ëŠ˜ì–´ë‚˜ë©´(scale-out) ì„œë²„ë¼ë¦¬ ì„¸ì…˜ ì •ë³´ë¥¼ ê³µìœ í•´ì•¼í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.  
 ë¡œë“œë°¸ëŸ°ì„œì— ì˜í•´ ì²˜ìŒ ë§¤í•‘ëœ ì„œë²„ê°€ ì´í›„ì—ë„ ë§¤í•‘ëœë‹¤ëŠ” ë³´ì¥ì´ ì—†ë‹¤.

**ğŸ§í† í° ê¸°ë°˜ ì¸ì¦ - `JWT (Json Web Token)`**  
 ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ë©´ ì„œë²„ëŠ” <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">ì‚¬ìš©ì ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ JWT í† í°ì„ ìƒì„±</span>í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬í•œë‹¤.  
 ì´í›„ ì‚¬ìš©ìëŠ” ìš”ì²­í•  ë•Œë§ˆë‹¤ <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">í—¤ë”ì— í† í°ì„ í¬í•¨ì‹œì¼œ ì„œë²„ì— ì „ì†¡</span>í•˜ê³ ,  
 ì„œë²„ëŠ” í† í°ì„ ê²€ì¦í•˜ì—¬ ì‚¬ìš©ìë¥¼ ì¸ì¦í•œë‹¤.

JWTëŠ” ì²˜ìŒ ë¡œê·¸ì¸í•  ë•Œ, <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">DBí†µì‹ ìœ¼ë¡œ ì–»ì€ íšŒì›ê°ì²´ë¥¼ Jsoní˜•íƒœë¡œ ë³€í™˜</span>í•œë‹¤.  
ì—¬ê¸°ì— <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">ë¹„ë°€ë²ˆí˜¸ë¥¼ ê±¸ì–´ ì•”í˜¸í™”</span>í•˜ê³ , ê·¸ ê²°ê³¼ì¸ ì•”í˜¸ë¬¸ì„ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬í•œë‹¤.  
í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ë§ˆë‹¤ í† í°ì„ í—¤ë”ì— ë„£ì–´ ë³´ë‚´ë©´  
ì„œë²„ëŠ” <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:rgba(193,151,210,0.7);">ì•”í˜¸í™”í•  ë•Œ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ìš©í•´ì„œ ë³µí˜¸í™”</span>í•˜ì—¬ íšŒì›ì •ë³´ê°€ ë‹´ê¸´ Jsonê°ì²´ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.  
ì¦‰, JWT í† í°ì„ í†µí•œ ì‚¬ìš©ì ì¸ì¦ë°©ì‹ì€, ìµœì´ˆ ë¡œê·¸ì¸ì„ ì œì™¸í•˜ê³   
ğŸ ì„œë²„ê°€ ë„¤íŠ¸ì›Œí¬ DBí†µì‹ ì„ í•˜ì§€ ì•Šê³ ë„ ì¸ì¦ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ ì†ë„ê°€ ë¹ ë¥´ë‹¤.

ì—¬ê¸°ì„œ <span style='color:rgb(196,58,26);'>ë³µí˜¸í™”í•˜ê¸° ìœ„í•´ ì¼ë˜ ë¹„ë°€ë²ˆí˜¸</span>ê°€ ë‚´ê°€ ì•”í˜¸í™”í–ˆë˜ ê°ì²´ë€ ê²ƒì„ ë³´ì¥í•œë‹¤.

ğŸ ë˜í•œ, ì¿ í‚¤ ì™¸ì—ë„ <span style='color:rgb(196,58,26);'>HTTP í—¤ë”</span>ë‚˜ <span style='color:rgb(196,58,26);'>ë¡œì»¬ ìŠ¤í† ë¦¬ì§€</span> ë“±ìœ¼ë¡œ í† í°ì„ ì €ì¥í•  ìˆ˜ ìˆì–´ <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgba(0,0,0,0.03);">ìœ ì—°ì„±ğŸ†</span>ì´ ë›°ì–´ë‚˜ë©°,

ğŸ í† í°ì€ <span style='color:rgb(196,58,26);'>í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ê´€ë¦¬</span>ë˜ë¯€ë¡œ, (ì„œë²„ê°€ ëŠ˜ì–´ë‚˜ëŠ” ê²ƒê³¼ ìƒê´€ì—†ì´) ëª¨ë°”ì¼ ì•±ì´ë‚˜ ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ìœ ìš©í•˜ë‹¤.

ë‹¤ë§Œ, ë‹¨ì ì€ í† í°ì´ íƒˆì·¨ë˜ë©´, ë§Œë£Œë˜ê¸° ì „ê¹Œì§€ ê³„ì† ì¸ì¦ì„ ìœ„í•´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.  
ì´ê°™ì€ ë‹¨ì ì„ ë³´ì™„í•˜ê¸° ìœ„í•´<span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#BCD4E6;">í† í° ë§Œë£Œ ì‹œê°„</span>ì„ ì§§ê²Œ ê°€ì ¸ê°€ê³ , ë˜ ì´ë¡œ ì¸í•œ ë¬¸ì œëŠ” ë§Œë£Œì‹œê°„ì´ ê¸´ <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#BCD4E6;">ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ë³´ì™„</span>í•´ì£¼ê¸°ë„ í•œë‹¤.

ì°¸ê³ ë¡œ, JWT í† í°ì˜ ê²½ìš° ì‚¬ìš©ì ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— í¬ê¸°ê°€ í´ ìˆ˜ ìˆì–´, ì˜¤ë²„í—¤ë“œë¥¼ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

## ë¹ˆ(Bean)ì´ ì´ˆê¸°í™”ë  ë•Œ íŠ¹ì • ë™ì‘ ìˆ˜í–‰, InitializingBean

<div style="margin-bottom:15px;font-size:20px;background-color:rgb(35,43,47);color:white;font-weight:normal;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    ğŸ Jwt í† í° ìƒì„±ì„ ìœ„í•´ íŠ¹ì • ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•´ ë¹„ë°€í‚¤ë¥¼ ìƒì„±í•˜ëŠ”ë°, ì´ˆê¸°í™”í•  ë•Œ ë¹„ë°€í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤
</div>

ë³´í†µ ìì‹ ì´ ì„¤ì •í•œ (ë¹„ë°€í‚¤ë¥¼ ìœ„í•œ) ë¬¸ìì—´ì€ <span style='color:rgb(196,58,26);'>Base64 ì¸ì½”ë”©</span>í•œ í›„,  
yml íŒŒì¼ì— ì‘ì„±í•œë‹¤.

<div style="margin-bottom:15px;font-size:15px;background-color:rgba(0,0,0,0.03);border-radius:5px;padding:7px;"><span style="font-weight:bold;">ğŸ“˜ Base64 ë€</span><br>
<span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:#DEDEDE;">Base64 ì•Œê³ ë¦¬ì¦˜</span>ì€ <span style='color:rgb(196,58,26);'>ë°”ì´ë„ˆë¦¬ ë°ì´í„°</span>ë¥¼ <span style='color:rgb(196,58,26);'>í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”©</span>í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì´ë‹¤.<br><br>
ì£¼ë¡œ ì´ë©”ì¼ ì „ì†¡, url ì¸ì½”ë”© ê°™ì€ ìƒí™©ì—ì„œ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ì „ì†¡í•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤.<br>
âš ï¸ Base64 ì•Œê³ ë¦¬ì¦˜ì€ 6ë¹„íŠ¸ ë‹¨ìœ„ì˜ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ 64ê°€ì§€ ASCII ë¬¸ìë¡œ ë³€í™˜í•œë‹¤.<br><br>
ë°˜ëŒ€ë¡œ <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:#DEDEDE;">Base64 ë””ì½”ë”©</span>ì€ <span style='color:rgb(196,58,26);'>í…ìŠ¤íŠ¸ ë°ì´í„°</span>ë¥¼ <span style='color:rgb(196,58,26);'>ë°”ì´ë„ˆë¦¬ í˜•ì‹</span>ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” ê³¼ì •ì´ë‹¤.
</div>

ìë°”ìš© JWT ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ `JJWT`ë¥¼ í†µí•´ `HMAC-SHA Algorithm` êµ¬í˜„í•œ ë©”ì„œë“œë¥¼ ì´ìš©í•´ ë¹„ë°€í‚¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

```gradle
dependencies {
    implementation group: 'io.jsonwebtoken', name: 'jjwt-api', version: '0.11.5'
    runtimeOnly group: 'io.jsonwebtoken', name: 'jjwt-impl', version: '0.11.5'
    runtimeOnly group: 'io.jsonwebtoken', name: 'jjwt-jackson', version: '0.11.5'
}
```

<div style="margin-bottom:15px;font-size:15px;background-color:#F7F6F3;border-radius:5px;padding:7px;"><span style="font-weight:bold;">ğŸ“• HMAC SHA ì•Œê³ ë¦¬ì¦˜ì´ë€</span><br>
<span style="font-size: 15px;font-weight:bold;">Hash-based Message Authentication Code Secure Hash Algorithm</span><br>
ë©”ì„¸ì§€ì˜ ë¬´ê²°ì„±ì„ ê²€ì¦í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” <span style='color:rgb(196,58,26);'>ì•”í˜¸í™” í•´ì‹œ í•¨ìˆ˜</span>ì´ë‹¤.<br><br>
<span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:#e1d1b8;">HMAC</span>ëŠ” ë©”ì„¸ì§€ ì¸ì¦ì½”ë“œë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ, <span style='color:rgb(196,58,26);'>í•´ì‹œí•¨ìˆ˜ì™€ ë¹„ë°€í‚¤ë¥¼ ê²°í•©</span>í•´ì„œ<br>
ë©”ì„¸ì§€ì˜ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ê³  ì¸ì¦í•œë‹¤.<br>
<span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:#e1d1b8;">SHA</span>ëŠ” <span style='color:rgb(196,58,26);'>í•´ì‹œí•¨ìˆ˜</span>ë¡œ, SHA-1, SHA-256, SHA-512 ë“±ì˜ ë³€ì¢…ì´ ìˆë‹¤.<br>
SHA ì•Œê³ ë¦¬ì¦˜ì€ <span style='color:rgb(196,58,26);'>ê³ ì • ê¸¸ì´ì˜ í•´ì‹œê°’ì„ ìƒì„±</span>í•œë‹¤.<br><br>
SHA-256ì€ í‚¤ë¥¼ ìƒì„±í•  ë¬¸ìì—´ì˜ í¬ê¸°ê°€ <B>ìµœì†Œ 32ë°”ì´íŠ¸</B>, SHA-512ëŠ” <B>ìµœì†Œ 64ë°”ì´íŠ¸</B>ë¼ëŠ” ì˜ë¯¸ë¥¼ ê°€ì§„ë‹¤.
</div>

```java
@Component
public class JwtTokenProvider implements InitializingBean {

  private final String secret;
  private final Long tokenValidityInMilliseconds;
  private Key key;

  public JwtTokenProvider(Environment env) {
    this.secret = env.getProperty("jwt.secret");
    this.tokenValidityInMilliseconds = Long.parseLong(Objects.requireNonNull(env.getProperty("jwt.token-validity-in-seconds"))) * 1000;
  }

  @Override
  public void afterPropertiesSet() {
    byte[] keyBytes = Decoders.BASE64.decode(secret);
    // ymlì— Base64ì¸ì½”ë”©ë˜ì–´ ìˆëŠ” í•´ì‹œê°’ì„ ë””ì½”ë”©í•œë‹¤. (í…ìŠ¤íŠ¸ -> ë°”ì´ë„ˆë¦¬ ë°ì´í„°)
    this.key = Keys.hmacShakeyFor(keyBytes);
    // HMAC SHA ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜, í•´ì‹œê°’ ìƒì„±
  }

  public String createToken(Authentication authentication) {
    // ì¸ì¦ëœ ì‚¬ìš©ì
    MemberDetails memberDetails = (MemberDetails) authentication.getPrincipal();

    String authorities = authentication.getAuthorities().stream()
      .map(GrantedAuthority::getAuthority)
      .collect(Collectors.joining(","));

      long now = (new Date()).getTime();
      Date validity = new Date(now + this.tokenValidityInMilliseconds);

      return Jwts.builder()
        .setSubject(authentication.getName()) // í† í° ì£¼ì œ ì„¤ì •
        .claim("memId", memberDetails.getMember().getMemberId().toString()) // ì‚¬ìš©ì ì •ì˜ í´ë ˆì„ ì¶”ê°€
        .claim("memberRole", authorities)
        .signWith(key, SignatureAlgorithm.HS512) // í† í°ì„ ì„œëª…í•  ì•Œê³ ë¦¬ì¦˜ê³¼ ë¹„ë°€ í‚¤ ì„¤ì •
        .setExpiration(validity) // í† í° ë§Œë£Œì‹œê°„ ì„¤ì •
        compact(); // ì§ë ¬í™”ëœ ë¬¸ìì—´ ë°˜í™˜
  }
}
```

`Keys.hmacShakeyFor()`ê°€ JJWT ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì œê³µí•˜ëŠ” `HMAC-SHA Algorithm`ì„ êµ¬í˜„í•œ ë©”ì„œë“œì´ë‹¤.

ì¦‰, ì¸ì½”ë”©ë˜ì–´ ymlì— ì‘ì„±ëœ, <span style='color:rgb(196,58,26);'>í‚¤ë¥¼ ìœ„í•œ í•´ì‹œê°’</span>ì„ ë””ì½”ë”©í•˜ê³  <span style='color:rgb(196,58,26);'>ì•”í˜¸í™”</span>í•˜ì—¬ (JWT ì„œëª…ì„ ìƒì„±í•˜ê³  ê²€ì¦í•˜ëŠ”ë° í•„ìš”í•œ) <span style='color:rgb(196,58,26);'>ë¹„ë°€í‚¤ë¥¼ ìƒì„±</span>í•œë‹¤.

ì´ ì‘ì—…ì„ í•˜ê¸° ì¢‹ì€ ì‹œì ì´ ë¹ˆì´ ìƒì„±ë˜ê³  ì´ˆê¸°í™”ëœ ì§ í›„ì´ê³ ,  
`InitializingBean` ì¸í„°í˜ì´ìŠ¤ì˜ `afterPropertiesSet` ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ <span style="margin-bottom:15px;padding:0 3px;border-radius:5px;background-color:#E1FEE5;">ì´ ì‹œì ì„ ë§ì¶°ì¤„ ìˆ˜ ìˆë‹¤.</span>

ìš”ì¦˜ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” `@PostConstruct`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ì¼ë°˜ì ì´ë‹¤.  
ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì— ëœ ì¢…ì†ì ì´ë©°, <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgba(0,0,0,0.03);">ê°€ë…ì„±ğŸ†</span>ì´ ì¢‹ê¸° ë•Œë¬¸ì´ë‹¤.

## ê¸°ë³¸ í† í° êµ¬ì¡° ì •ì˜, AbstractAuthenticationToken

<div style="margin-bottom:15px;font-size:20px;background-color:rgb(35,43,47);color:white;font-weight:normal;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    ğŸ AbstractAuthenticationTokenì€ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì œê³µí•˜ëŠ” í† í° êµ¬ì¡° ì •ì˜ ì¶”ìƒ í´ë˜ìŠ¤ì´ë‹¤
</div>

`ğŸª™AbstractAuthenticationToken`ì€ ì¸ì¦ê³¼ ê´€ë ¨ëœ <span style='color:rgb(196,58,26);'>ì •ë³´ë¥¼ ìº¡ìŠí™”</span>í•œë‹¤.  
ì¸ì¦ì£¼ì²´ `principal`, ê¶Œí•œì •ë³´ `authorities`, ìê²©ì¦ëª… `credentials`, ì¸ì¦ìƒíƒœê´€ë¦¬`isAuthenticated` `setAuthenticated`

`Jwt Token` ì„œëª…ì„ í†µí•´, ì„œëª…ì´ ì •ìƒì´ë©´ `Authentication` ê°ì²´ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.  
ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ë§Œë“¤ì–´ ì£¼ëŠ” ì´ `Authentication` ê°ì²´ëŠ” ì‚¬ì‹¤ `Principal`ì„ í™•ì¥í•œ í˜•íƒœì´ë‹¤.  
<span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgba(0,0,0,0.03);">Authentication extends Principal</span>

`ğŸª™ JwtAuthenticationToken.java`

```java
@Getter
public class JwtAuthenticationToken extends AbstractAuthenticationToken {

  private final Object principal;
  private final Object credentials;

  public JwtAuthenticationToken(Object principal, Object credentials) {
    super(null); //authorities: null
    this.principal = principal;
    this.credentials = credentials;
    setAuthenticated(false);
  }

  public JwtAuthenticationToken(
      Object principal, Object credentials, Collection<? extends GrantedAuthority> authorities) {
        super(authorities);
        this.principal = principal;
        this.credentials = credentials;
        setAuthenticated(true);
  }

  //ì¸ì¦ ì²˜ë¦¬ ì „ í˜¸ì¶œ
  public static JwtAuthenticationToken unauthenticated(Object principal, Object credentials) {
    return new JwtAuthenticationToken(principal, credentials);
  }

  // ì¸ì¦ ì²˜ë¦¬ í›„ í˜¸ì¶œ
  public static JwtAuthenticationToken authenticated(Object principal, Object credentials, Collection<? extends GrantedAuthority> authorities) {
    return new JwtAuthenticationToken(principal, credentials, authorities);
  }
}
```

## Jwt í† í° ìƒì„±

<div style="margin-bottom:15px;font-size:20px;background-color:#652DC1;color:white;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    ğŸ™ Jwt í† í° ìƒì„±
</div>

- Jwt í† í°  
  <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgba(0,0,0,0.03);">ğŸª™ header.payload.signature</span>

  - Header
    í•´ì‹± ì•Œê³ ë¦¬ì¦˜, í† í° íƒ€ì…

    ```json
    {
      "alg": "HS256",
      "typ": "JWT"
    }
    ```

  - Payload
    í† í° ì£¼ì œ, í† í° ë§Œë£Œì‹œê°„, ...  
    <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgb(196,58,26);color:white;">claim</span>ì´ë€ **Jwtê°€ ì •ë³´ë¥¼ í‘œí˜„í•˜ëŠ” ìš©ì–´**ë‹¤.

    ```json
    {
      "sub": "subject",
      "name": "peter",
      "iat": 1516239022,
      "exp": 1516242622,
      "iss": "issuer",
      "aud": "audience",
      "roles": ["user", "admin"],
      "permission": {
        "read": true,
        "write": false,
        "delete": false
      }
    }
    ```

  - Signature  
    : <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgba(0,0,0,0.03);">(Encoded)í—¤ë”</span> + <span style="margin-bottom:15px;padding:0 3px;font-size:16px;border-radius:5px;background-color:rgba(0,0,0,0.03);">(Encoded)í˜ì´ë¡œë“œ</span> + <span style='color:rgb(196,58,26);'>ë¹„ë°€í‚¤</span>

    ```text
    HMACSHA256(
      base64UrlEncode(header) + "." + base64UrlEncode(payload),
      secret
    )
    ```

## Authorization í—¤ë”ë¥¼ í†µí•œ ì¸ì¦ê³¼, BasicAuthenticationFilter

<div style="margin-bottom:15px;font-size:20px;background-color:rgb(196,58,26);color:white;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    ğŸˆ BasicAuthenticationFilterëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ HTTP Basic ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” í•„í„°ë‹¤
</div>

í—¤ë”ì— ì¸ì½”ë”©ëœ ìê²©ì¦ëª…ì´ ë…¸ì¶œë  ìˆ˜ ìˆê³ , ì´ë¥¼ ë³µí˜¸í™”í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—  
HTTP Basic ì¸ì¦ì€ ê¶Œê³ í•˜ì§€ ì•ŠëŠ”ë‹¤.

ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì œê³µí•˜ëŠ” `ğŸ›¡ï¸BasicAuthenticationFiler`ë¥¼ ìƒì†ë°›ì•„ ì“¸ ìˆ˜ ìˆë‹¤.  
ì´ ê°™ì€ ì¸ì¦ë°©ì‹ì´ ê°€ëŠ¥í•œ ì´ìœ ëŠ” ë‹¨ìˆœ ìê²©ì¦ëª…(ì´ë¦„, ì•”í˜¸)ë¥¼ `Authorization` í—¤ë”ì— ë„˜ê¸°ëŠ” ê²ƒì´ ì•„ë‹Œ  
ì¸ì½”ë”©ëœ í—¤ë”ì™€ í˜ì´ë¡œë“œ ê·¸ë¦¬ê³  ë¹„ë°€í‚¤ë¥¼ ì¡°í•©í•´ì„œ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ëŒë¦¬ê³ , ì´ë¥¼ í†µí•´  
ìƒì„±í•œ <span style='color:rgb(196,58,26);'>í•´ì‹œê°’(Signature)</span>ì„ ë³´ë‚´ê¸° ë•Œë¬¸ì—, ë³´ì•ˆì¸¡ë©´ì—ì„œ ë” ì•ˆì „í•˜ë‹¤.

ê²°êµ­, `ğŸ›¡ï¸BasicAuthenticationFilter`ë¥¼ ì“°ëŠ” ì´ìœ ëŠ” ì´ í•„í„°ê°€ `Authorization` í—¤ë”ë¥¼ ì½ê³  ìœ íš¨í•œ ì¸ì¦ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ” í•„í„°ì´ê¸° ë•Œë¬¸ì´ë‹¤.

`ğŸ¦© JwtAuthorizationFilter.java`

```java
public class JwtAuthorizationFilter extends BasicAuthenticationFilter {

  private final String HEADER_STR = "Authorization";
  private final String TOKEN_PREFIX = "Bearer ";
  private final String secret;

  private final MemberRepository memberRepository;

  public JwtAuthorizationFilter(
    AuthenticationManager authenticationManager,
    MemberRepository memberRepository,
    Environment env) {
      super(authenticationManager);
      this.memberRepository = memberRepository;
      this.secret = env.getProperty("jwt.secret");
  }

  @Override
  protected void doFilterInternal(
    HttpServletRequest request,
    HttpServletResponse response,
    FilterChain chain) {

      String header = request.getHeader(HEADER_STR);
      if(header == null || !header.startsWith(TOKEN_PREFIX)) {
        chain.doFilter(request, response);
        return;
      }

      String jwtToken = header.replace(TOKEN_PREFIX, "");

      byte[] keyBytes = Decoders.BASE64.decode(secret);
      SecretKey key = Keys.hmacShaKeyFor(keyBytes);

      try {
        // Jwtê°€ ì‚¬ìš©ì ì •ë³´ í‘œí˜„í•˜ëŠ” ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
        // ì´ë•Œ ë¹„ë°€í‚¤ê°€ í•„ìš”í•˜ë‹¤
        Claims claims = Jwts.parserBuilder()
          .setSigningKey(key)
          .build()
          .parsingClaimsJws(jwt)
          .getBody();

        // Claimìœ¼ë¡œë¶€í„° ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
        Long memId = Long.parseLong(claims.get("memId", String.class));
        if(memId != null) {
          // ë¹¼ë‚´ì˜¨ ì •ë³´(ì‚¬ìš©ìì‹ë³„ID)ë¡œ ë¶€í„° DBí†µì‹ ì„ í†µí•´ ì„¸ë¶€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
          Member foundMem = memberRepository.findById(memId).orElseThrow();
          // ì‹œíë¦¬í‹° ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì„ì˜ì˜ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤
          MemberDetails memDetails = new MemberDetails(foundMember);

          // ì„ì˜ì˜ ì‚¬ìš©ì ì¸ì¦ í† í°ì„ ìƒì„±í•œë‹¤
          // ì´ë¯¸ ì¸ì¦ëœ ê²½ìš°ì´ë¯€ë¡œ credentialsì—ëŠ” nullì„ ë„£ì–´ì¤€ë‹¤
          Authentication authentication = new UsernamePasswordAuthenticationToken(memDetails, null, memDetails.getAuthorities());

          // ê°•ì œë¡œ ì‹œíë¦¬í‹°ì˜ ì„¸ì…˜ì— ì ‘ê·¼í•˜ì—¬ ì¸ì¦ê°ì²´ë¥¼ ë„£ì–´ì¤€ë‹¤
          // ì¸ì¦ ì™„ë£Œ
          SecurityContextHolder.getContext().setAuthentication(authentication);
        } else {
          // ...ì—ëŸ¬ ì²˜ë¦¬(ìƒëµ)
        }

        chain.doFilter(request, response);
      }
  }
}
```

`ğŸ›¡ï¸SecurityContextHolder`ëŠ” <span style='color:#9E0ADD;'>í˜„ì¬ ìŠ¤ë ˆë“œì™€ ì—°ê´€ëœ</span> <span style='color:rgb(196,58,26);'>ë³´ì•ˆì»¨í…ìŠ¤íŠ¸</span> ê°ì²´ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•œë‹¤.  
ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ëŠ” ì¸ì¦ê³¼ì •ì—ì„œ `ğŸ›¡ï¸SecurityContextHolder`ì— <span style='color:#9E0ADD;'>ì¸ì¦ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •</span>í•˜ì§€ë§Œ,  
ìœ„ì˜ ì½”ë“œì™€ ê°™ì´ íŠ¹ì • ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” <span style='color:rgb(196,58,26);'>ì§ì ‘ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.</span>

`Authentication auth = SecurityContextHolder.getContext().getAuthentication()`  
ì´ì²˜ëŸ¼ `ğŸ›¡ï¸SecurityContextHolder`ë¡œë¶€í„° ì¸ì¦ê°ì²´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê³ ,  
ì¸ì¦ ê°ì²´ë¥¼ í†µí•´ ë‹¤ì–‘í•œ ì¸ì¦ ì •ë³´ë¥¼ ë¹¼ì˜¬ ìˆ˜ë„ ìˆë‹¤.  
`auth.getName()` `auth.getAuthorities()` `auth.isAuthenticated`

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹° FilterChainê³¼ Jwt ì¸ì¦/ì¸ê°€ í”Œë¡œìš°

<div style="margin-bottom:15px;font-size:20px;background-color:rgb(45,204,112);color:white;border-top-left-radius:5px;border-top-right-radius:5px;padding:2px;overflow-x:auto;white-space:nowrap;">
    âš”ï¸ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° FilterChainê³¼ Jwt ì¸ì¦/ì¸ê°€ í”Œë¡œìš°
</div>

`ğŸ« SecurityConfig.java`

```java
@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

  // ...(ìƒëµ)

  public class MyCustomDsl extends AbstractHttpConfigurer<MyCustomDsl, HttpSecurity> {

    AuthenticationManager authenticationManager = http.getSharedObject(AuthenticationManager.class);

    // ...(ìƒëµ)

    http.addFilterBefore(initialAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)
      .addFilterAfter(jwtAuthenticationFilter, InitialAuthenticationFilter.class)
      .authenticationProvider(jwtAuthenticationProvider);

      http.addFilter(new JwtAuthorizationFilter(authenticationManager));
  }
}
```

ì‹œíë¦¬í‹° ì„¤ì •ì—ì„œ ê¸°ì¡´ filter chainì— ë‹¤ìŒê³¼ ê°™ì€ íë¦„ì„ ê°€ì§€ëŠ” ë§ì¶¤í˜• í•„í„°ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.

![Alt text](https://i.esdrop.com/d/f/OAHra5CzfD/AigEAaP5kC.png "Optional title"){: width="800" height="500"}

ì¸ì¦ê´€ë¦¬ìëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ ê¸°ì¡´ ì¸ì¦ê´€ë¦¬ìë¥¼ ì‚¬ìš©í–ˆê³ ,  
ì¸ì¦ê³µê¸‰ìëŠ” ê¸°ì¡´ ì¸ì¦ê³µê¸‰ìë¥¼ í™•ì¥í•œ ë§ì¶¤í˜• ë¹ˆ `JwtAuthenticationProvider`ë¥¼ ì‚¬ìš©í–ˆë‹¤.

`â˜• JwtAuthenticationProvider.java`

```java
public class JwtAuthentiationProvider implements AuthenticationProvider {

  private final MemberDetailsService memberDetailsService;
  private final PasswordEncoder passwordEncoder;

  public JwtAuthenticationProvider(MemberDetailsService memberDetailsService) {
    this.memberDetailsService = memberDetailsService;
    this.passwordEncoder = new BCryptPasswordEncoder();
  }

  // ì§€ì›í•˜ì§€ ì•ŠëŠ” ì¸ì¦ ê°ì²´ë¥¼ ë°›ìœ¼ë©´ null ë°˜í™˜
  @Override
  public Authentication authenticate(Authentication authentication) throws AuthenticationException {
    String username = authentication.getName();
    String password = authentication.getCredentials().toString();

    MemberDetails memberDetails = memberDetailsService.loadUserByUsername(username);

    //íƒˆí‡´í•œ íšŒì›
    if(!memberDetails.isEnabled()) {
      throw new AuthenticationException(CustomErrMessage.INACTIVE_MEMBER) {
        @Override
        public String getMessage() { return super.getMessage(); }
      }
    }

    // ì•”í˜¸ ì¸ì½”ë”ë¡œ ì•”í˜¸(ë¹„ë°€ë²ˆí˜¸) ê²€ì¦
    if(!passwordEncoder.matches(password, memberDetails.getPassword())) {
      throw new BadCredentialsException(CustomErrMessage.NOT_FOUND_CREDENTIALS);
    }

    return JwtAuthenticationToken.authenticated(memberDetails, null, memberDetails.getAuthorities());
  }

  // ì§€ì›í•˜ëŠ” ì¸ì¦ ìœ í˜• ì„¤ì •
  @Override
  public boolean supports(Class<?> authenticationType) {
    return authenticationType.equals(JwtAuthenticationToken.class);
  }
}
```

ì‚¬ìš©ìë¥¼ ì°¾ê¸° ìœ„í•´ `authenticate` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ëŠ”ë° ì´ ë•Œ,
íŒŒë¼ë¯¸í„°ë¡œ í•´ë‹¹ ì¸ì¦ê³µê¸‰ìê°€ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê°ì²´ë¥¼ ë°›ìœ¼ë©´ nullì„ ë°˜í™˜í•œë‹¤.

ì—¬ê¸°ì„œ ì‚¬ìš©ì ì¸ì¦ê³¼ì •ì´ ì¼ì–´ë‚œë‹¤.  
dbí†µì‹ ì„ í†µí•´ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì°¾ê³ , `PasswordEncoder`ë¥¼ í†µí•´ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ëŠ”ì§€ í™•ì¸í•œë‹¤.

ë§Œì¼, ì¸ì¦ê³¼ì •ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤ë©´<span style="margin-bottom:16px;font-size:15px;background-color:#ffdce0;color:rgb(196,58,26);font-weight:bold;border-radius:5px;padding:2px 3px;">AuthenticationException</span>ì´ë¼ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì œê³µí•˜ëŠ” ì˜ˆì™¸ê°€ ë°œìƒí•˜ê³ ,  
ì´ ì˜ˆì™¸ëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹° í•¸ë“¤ëŸ¬ì— ì˜í•´ ì²˜ë¦¬ë  ìˆ˜ ìˆë‹¤.

ì‚¬ìš©ì ì¸ì¦ê³¼ì •ì—ì„œ ì œê³µëœ ìê²©ì¦ëª…ì´ ìœ íš¨í•˜ì§€ ì•Šì„ ë•Œ <span style="margin-bottom:16px;font-size:15px;background-color:#ffdce0;color:rgb(196,58,26);font-weight:bold;border-radius:5px;padding:2px 3px;">BadCredentialException</span>ì´ ë°œìƒí•˜ëŠ”ë° ì´ëŠ” <span style="margin-bottom:16px;font-size:15px;background-color:#ffdce0;color:rgb(196,58,26);font-weight:bold;border-radius:5px;padding:2px 3px;">AuthenticationException</span>ì˜ í™•ì¥ëœ í˜•íƒœì´ë‹¤.
